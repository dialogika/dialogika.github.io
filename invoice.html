<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Confirmation | Dialogika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .disabled-input { background-color: #f1f5f9; cursor: not-allowed; color: #94a3b8; }
        .upload-area:hover { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 antialiased">

    <!-- HEADER CONTEXT -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
        <div class="max-w-xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight" id="leadName">Andi Pratama</h1>
                    <p class="text-sm text-slate-500 font-medium">Konfirmasi Pembayaran Anda</p>
                    <p class="mt-1 text-[11px] font-mono text-slate-400">
                        Invoice <span id="invoiceNumber" class="font-semibold text-slate-600"></span>
                    </p>
                </div>
                <div class="flex items-center">
                    <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika" class="h-9 w-auto">
                </div>
            </div>
            
            <div class="mt-4 p-4 bg-slate-900 rounded-2xl text-white" style="background-color: #0b2b6a;box-shadow: 0px 7px 9px -6px rgba(114, 4, 207, 1);">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Kelas Yang Diambil</p>
                <div class="flex justify-between items-end mt-1">
                    <div>
                        <h2 class="font-bold text-lg" id="className">Public Speaking Playbook</h2>
                        <div class="mt-1 flex flex-wrap items-center gap-2">
                            <span id="badgeBatch" class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-black bg-green-700 text-slate-100 uppercase tracking-widest">Batch 42</span>
                            <span id="badgeType" class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-black bg-green-700 text-slate-100 uppercase tracking-widest">Offline</span>
                            <span id="badgeLocation" class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-black bg-green-700 text-slate-100 uppercase tracking-widest">Jakarta</span>
                        </div>
                        <div class="mt-1">
                            <span id="seatLeftLabel" class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-black bg-emerald-500/10 text-emerald-500 uppercase tracking-widest">
                                Sisa Seat : 4
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] block opacity-60 uppercase font-bold">Total Harga</span>
                        <span class="text-lg font-black text-green-400" id="displayBasePrice">Rp 2.500.000</span>
                    </div>
                </div>
            </div>

            <div class="mt-3 p-3 bg-red-500 rounded-2xl text-white flex items-center justify-between">
                <div>
                    <p class="text-[10px] text-white-300 font-bold uppercase tracking-widest">Batas Waktu Pembayaran</p>
                    <p class="text-[11px] text-white-400 font-medium">Selesaikan pembayaran sebelum waktu habis.</p>
                </div>
                <div class="text-right">
                    <span id="countdownTimer" class="font-mono text-xl font-black">00:00</span>
                </div>
            </div>
        </div>
        
    </header>

    <main class="max-w-xl mx-auto px-6 mt-8 pb-20">
        
        <!-- MAIN FORM CARD -->
        <div class="bg-white rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
            <div class="p-8 space-y-6">
                
                <!-- 1. PRICE (READ ONLY) -->
                <div>
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Harga Kelas</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold font-mono text-lg">Rp</span>
                        <input type="text" id="inputPrice" value="2.500.000" readonly 
                            class="w-full pl-12 pr-4 py-4 disabled-input border-2 border-slate-100 rounded-2xl text-xl font-black outline-none">
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Kode Referral <a href="https://api.whatsapp.com/send?phone=6285162992597&text=Kak%2C%20aku%20mau%20payment%2C%20tapi%20referralnya%20expired%2C%20boleh%20minta%20lagi" target="_blank">(Chat Admin)</a></label>
                    <div class="relative">
                        <input type="text" id="referralCode" class="w-full p-4 pr-24 bg-slate-50 border-2 border-slate-100 rounded-2xl text-sm font-medium outline-none focus:border-blue-500 transition-all" placeholder="Masukkan kode referral jika ada">
                        <button type="button" onclick="checkReferral()" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-black rounded-xl uppercase tracking-widest">Check</button>
                    </div>
                    <p id="referralMessage" class="hidden text-[10px] font-bold mt-1 uppercase tracking-tight"></p>
                </div>

                <!-- 2. PAYMENT TYPE -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="w-full">
                        <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Tipe Pembayaran</label>
                        <select id="paymentType" onchange="handlePaymentTypeChange()" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-black text-lg outline-none focus:border-blue-500 transition-all">
                            <option value="full">Lunas (Full Payment)</option>
                            <option value="dp">DP (Down Payment)</option>
                        </select>
                    </div>
                    <div class="w-full">
                        <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Nominal Bayar</label>
                        <input type="text" id="amountPaid" value="2500000" readonly
                            oninput="handleAmountInputChange()"
                            class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-black text-lg outline-none focus:border-blue-500 transition-all">
                        <p id="minWarning" class="hidden text-[10px] text-red-500 font-bold mt-1 uppercase tracking-tight italic">* Minimal DP 35% (Rp 875.000)</p>
                    </div>
                </div>

                <!-- 3. METHOD SELECT -->
                <div>
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Metode Pembayaran</label>
                    <div class="space-y-3">
                        <select id="paymentMethod" onchange="handleMethodChange()" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold text-sm outline-none focus:border-blue-500 transition-all">
                            <option value="Transfer Bank">Transfer Bank</option>
                            <option value="Cash">Cash (Tunai)</option>
                            <option value="QRIS" disabled>QRIS (Coming Soon)</option>
                        </select>
                    </div>
                </div>

                <!-- 4. CONDITIONAL SECTION: TRANSFER BANK -->
                <div id="sectionTransfer" class="space-y-4 animate-in fade-in slide-in-from-top-4 duration-300">
                    <div>
                        <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Pilih Bank</label>
                        <select id="bankOption" onchange="handleBankChange()" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold text-sm outline-none focus:border-blue-500 transition-all">
                            <option value="BCA">BCA</option>
                            <option value="BCA Syariah">BCA Syariah</option>
                            <option value="BSI">BSI</option>
                            <option value="BRI">BRI</option>
                            <option value="SMBC">SMBC</option>
                        </select>
                    </div>

                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                        <p class="text-[11px] font-black text-blue-600 uppercase tracking-widest mb-2">Rekening Tujuan</p>
                        <div class="flex justify-between items-center">
                            <div>
                                <span id="displayBankInfo" class="font-black text-slate-700 block">BCA - 8920129301</span>
                                <span id="displayAccountHolder" class="text-xs text-slate-500 font-semibold">a.n. PT Dialogika Indonesia</span>
                            </div>
                            <span id="copyRekeningBtn" onclick="copyRekening()" class="text-[10px] bg-white px-2 py-1 rounded border border-blue-200 text-blue-600 font-bold cursor-pointer select-none">Copy</span>
                        </div>
                        
                    </div>

                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Upload Bukti Transfer</label>
                    <div id="uploadArea" class="upload-area relative border-2 border-dashed border-slate-200 rounded-2xl p-8 h-64 transition-all group">
                        <input type="file" id="fileUpload" accept="image/*,.pdf" onchange="handleFileUpload()" 
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div id="uploadPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-center pointer-events-none">
                            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                <i data-lucide="upload-cloud" class="text-blue-600 w-6 h-6"></i>
                            </div>
                            <p class="text-sm font-bold text-slate-700">Klik atau seret file ke sini</p>
                            <p class="text-[10px] text-slate-400 mt-1 font-medium">PNG, JPG, atau PDF (Maks. 5MB)</p>
                        </div>
                        <div id="uploadSpinner" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center">
                            <div class="w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <div id="uploadPreview" class="hidden absolute inset-0 bg-slate-900/80">
                            <img id="uploadPreviewImage" src="" alt="Preview Bukti Transfer" class="w-full h-full object-contain">
                            <div class="absolute bottom-0 left-0 right-0 px-4 py-2 text-[10px] text-slate-100 font-semibold truncate bg-black/50" id="uploadPreviewName"></div>
                        </div>
                    </div>
                    <!-- Success Upload Message -->
                    <div id="uploadSuccess" class="hidden flex items-center gap-2 p-3 bg-green-50 rounded-xl border border-green-100 animate-pulse">
                        <i data-lucide="check-circle-2" class="text-green-600 w-5 h-5"></i>
                        <p class="text-xs font-bold text-green-700 uppercase italic tracking-tight">Berhasil diupload! Segera pencet tombol di bawah untuk konfirmasi ke admin.</p>
                    </div>

                    
                </div>

                <!-- 5. CONDITIONAL SECTION: CASH -->
                <div id="sectionCash" class="hidden space-y-4 animate-in fade-in slide-in-from-top-4 duration-300">
                    <div class="p-6 bg-amber-50 rounded-2xl border border-amber-100 text-center">
                        <i data-lucide="map-pin" class="text-amber-600 w-10 h-10 mx-auto mb-3"></i>
                        <h4 class="font-black text-amber-800 text-sm uppercase tracking-wide">Pembayaran Tunai</h4>
                        <p class="text-xs text-amber-700 mt-2 leading-relaxed">Silahkan janjian untuk bertemu **Admin Marketing Dialogika** di kantor pusat atau lokasi kelas yang telah disepakati.</p>
                    </div>
                </div>

                <!-- PRIMARY BUTTON -->
                <div class="pt-4">
                    <button id="mainBtn" onclick="submitDeal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-[1.5rem] text-lg shadow-xl shadow-blue-200 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                        <span id="btnText">CONFIRM PAYMENT</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                    <p class="text-center text-[10px] text-slate-400 mt-4 font-bold uppercase tracking-widest">Click Button di Atas untuk Konfirmasi Pembayaran.</p>
                </div>

            </div>
        </div>

        <section id="invoiceDetailsWrapper" class="mt-6 space-y-4">
            <div class="bg-white rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
                <button type="button" id="invoiceDetailsToggle" class="w-full flex items-center justify-between px-6 py-4">
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Details Program</p>
                        <p id="invoiceDetailsSubtitle" class="text-xs text-slate-500 mt-1">Klik untuk melihat rincian program.</p>
                    </div>
                    <span id="invoiceDetailsIcon" class="w-8 h-8 rounded-full border border-slate-200 flex items-center justify-center text-lg font-bold text-slate-500">+</span>
                </button>
                <div id="invoiceDetailsContent" class="border-t border-slate-100 px-6 py-5 space-y-5 text-sm text-slate-800 hidden">
                    <div id="invoiceDetailsLoading" class="text-xs text-slate-500">Memuat detail program...</div>
                    <div id="invoiceCurriculumBlock" class="space-y-2 hidden">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Curriculum</p>
                        <ol id="invoiceCurriculumList" class="list-decimal list-inside space-y-1 text-[13px]"></ol>
                    </div>
                    <div id="invoiceFeaturesBlock" class="space-y-2 hidden">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Key Features</p>
                        <ul id="invoiceFeaturesList" class="space-y-1 text-[13px]"></ul>
                    </div>
                    <div id="invoiceSpecificationsBlock" class="space-y-2 hidden">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Specification</p>
                        <ul id="invoiceSpecificationsList" class="space-y-1 text-[13px]"></ul>
                    </div>
                    <div id="invoiceReferralBlock" class="space-y-1 hidden">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Potongan Referral</p>
                        <p id="invoiceReferralValue" class="text-[13px] font-semibold text-emerald-600"></p>
                    </div>
                </div>
            </div>
            <div class="flex justify-end">
                <button type="button" onclick="printInvoice()" class="inline-flex items-center gap-2 px-4 py-3 rounded-full bg-slate-900 text-white text-[11px] font-black uppercase tracking-[0.25em] shadow-lg shadow-slate-300/60">
                    Cetak Invoice
                </button>
            </div>
        </section>
    </main>

    <div id="uploadPreviewModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="max-w-full max-h-full p-4">
            <img id="uploadPreviewModalImage" src="" class="max-h-[90vh] max-w-[90vw] object-contain bg-black">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5",
            measurementId: "G-SXN811P3N0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        window.dlgInvoiceDb = db;
        window.dlgInvoiceDoc = doc;
        window.dlgInvoiceGetDoc = getDoc;
        window.dlgInvoiceUpdateDoc = updateDoc;
        window.dlgInvoiceSetDoc = setDoc;
        window.dlgInvoiceStorage = storage;
        window.dlgInvoiceStorageRef = storageRef;
        window.dlgInvoiceUploadBytes = uploadBytes;
        window.dlgInvoiceGetDownloadURL = getDownloadURL;
        window.dlgInvoiceCollection = collection;
        window.dlgInvoiceGetDocs = getDocs;
        console.log("Firebase initialized in invoice.html");
    </script>

    <script>
        lucide.createIcons();

        const STORAGE_KEY_SETTINGS = "dlg_invoice_settings";
        const STORAGE_KEY_BANKS = "dlg_invoice_banks";
        const STORAGE_KEY_REFERRALS = "dlg_invoice_referrals";

        function loadInvoiceSettings() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_SETTINGS);
                if (!raw) {
                    return {
                        leadName: "Andi Pratama",
                        className: "Public Speaking Playbook",
                        batchLabel: "Batch 42",
                        classType: "Offline",
                        location: "Jakarta",
                        seatsLeft: 4,
                        deadlineMinutes: 60,
                        basePrice: 2500000,
                        dpPercent: 35,
                        classMeta: "Batch 42 • Offline • Jakarta"
                    };
                }
                const parsed = JSON.parse(raw);
                const merged = Object.assign({
                    leadName: "Andi Pratama",
                    className: "Public Speaking Playbook",
                    batchLabel: "Batch 42",
                    classType: "Offline",
                    location: "Jakarta",
                    seatsLeft: 4,
                    deadlineMinutes: 60,
                    basePrice: 2500000,
                    dpPercent: 35,
                    classMeta: "Batch 42 • Offline • Jakarta"
                }, parsed);
                if (!merged.batchLabel && merged.classMeta) {
                    const parts = merged.classMeta.split("•").map(function (s) { return s.trim(); }).filter(function (s) { return s.length > 0; });
                    merged.batchLabel = parts[0] || "";
                    merged.classType = parts[1] || "";
                    merged.location = parts[2] || "";
                }
                return merged;
            } catch (e) {
                return {
                    leadName: "Andi Pratama",
                    className: "Public Speaking Playbook",
                    batchLabel: "Batch 42",
                    classType: "Offline",
                    location: "Jakarta",
                    seatsLeft: 4,
                    deadlineMinutes: 60,
                    basePrice: 2500000,
                    dpPercent: 35,
                    classMeta: "Batch 42 • Offline • Jakarta"
                };
            }
        }

        async function loadBanksForInvoice() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_BANKS);
                if (!raw) {
                    // Coba muat dari Firestore jika localStorage kosong
                    if (window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc) {
                        const docRef = window.dlgInvoiceDoc(window.dlgInvoiceDb, "settings", "banks");
                        const docSnap = await window.dlgInvoiceGetDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const banks = data.banks || [];
                            const map = {};
                            banks.forEach(function (b) {
                                const name = b && b.name ? String(b.name).trim() : "";
                                if (!name) return;
                                map[name] = { number: b.number || "", holder: b.holder || "" };
                            });
                            return map;
                        }
                    }
                    return null;
                }
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed) || !parsed.length) return null;
                const map = {};
                parsed.forEach(function (b) {
                    const name = b && b.name ? String(b.name).trim() : "";
                    if (!name) return;
                    map[name] = { number: b.number || "", holder: b.holder || "" };
                });
                return map;
            } catch (e) {
                return null;
            }
        }

        async function loadReferralsForInvoice() {
            try {
                if (window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc) {
                    const docRef = window.dlgInvoiceDoc(window.dlgInvoiceDb, "settings", "referrals");
                    const docSnap = await window.dlgInvoiceGetDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const referrals = data.referrals || [];
                        if (Array.isArray(referrals) && referrals.length) {
                            try {
                                localStorage.setItem(STORAGE_KEY_REFERRALS, JSON.stringify(referrals));
                            } catch (e) {}
                            return referrals;
                        }
                    }
                }
                const raw = localStorage.getItem(STORAGE_KEY_REFERRALS);
                if (!raw) {
                    return [];
                }
                const parsed = raw ? JSON.parse(raw) : [];
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        const params = new URLSearchParams(window.location.search);
        const invoiceIdFromUrl = params.get("invoiceId") || "";

        let invoiceSettings = loadInvoiceSettings();
        let basePrice = invoiceSettings.basePrice || 2500000;
        let dpPercent = invoiceSettings.dpPercent || 35;
        let minDP = Math.round(basePrice * dpPercent / 100);
        let originalBasePrice = basePrice;
        let appliedReferralDiscount = 0;

        function generateInvoiceNumber() {
            const now = new Date();
            const yy = String(now.getFullYear()).slice(-2);
            const mm = String(now.getMonth() + 1).padStart(2, "0");
            const dd = String(now.getDate()).padStart(2, "0");
            const random = Math.floor(Math.random() * 9000) + 1000;
            return "INV-" + yy + mm + dd + "-" + random;
        }

        function renderInvoice(settings, invoiceNumberOverride) {
            const invoiceEl = document.getElementById("invoiceNumber");
            const leadEl = document.getElementById("leadName");
            const classEl = document.getElementById("className");
            const badgeBatchEl = document.getElementById("badgeBatch");
            const badgeTypeEl = document.getElementById("badgeType");
            const badgeLocationEl = document.getElementById("badgeLocation");
            const seatEl = document.getElementById("seatLeftLabel");
            const countdownEl = document.getElementById("countdownTimer");
            const displayBasePriceEl = document.getElementById("displayBasePrice");
            const priceInputEl = document.getElementById("inputPrice");
            const minWarningEl = document.getElementById("minWarning");

            if (invoiceEl) {
                if (invoiceNumberOverride) {
                    invoiceEl.textContent = invoiceNumberOverride;
                } else {
                    invoiceEl.textContent = generateInvoiceNumber();
                }
            }
            if (leadEl) leadEl.textContent = settings.leadName || leadEl.textContent;
            if (classEl) classEl.textContent = settings.className || classEl.textContent;
            if (badgeBatchEl && settings.batchLabel) badgeBatchEl.textContent = settings.batchLabel;
            if (badgeTypeEl && settings.classType) badgeTypeEl.textContent = settings.classType;
            if (badgeLocationEl && settings.location) badgeLocationEl.textContent = settings.location;
            if (seatEl && typeof settings.seatsLeft === "number") {
                seatEl.textContent = "Sisa Seat : " + settings.seatsLeft;
            }
            if (displayBasePriceEl) {
                displayBasePriceEl.textContent = "Rp " + basePrice.toLocaleString("id-ID");
            }
            if (priceInputEl) {
                priceInputEl.value = basePrice.toLocaleString("id-ID");
            }
            if (minWarningEl) {
                minWarningEl.textContent = "* Minimal DP " + dpPercent + "% (Rp " + minDP.toLocaleString("id-ID") + ")";
            }
            if (countdownEl && settings.deadlineMinutes) {
                countdownEl.textContent = String(settings.deadlineMinutes).padStart(2, "0") + ":00";
            }
            const leadForTitle = settings.leadName || (leadEl ? leadEl.textContent : "");
            if (leadForTitle) {
                document.title = leadForTitle + " | Payment Confirmation | Dialogika";
            } else {
                document.title = "Payment Confirmation | Dialogika";
            }
        }

        function updatePriceFieldsAfterBasePriceChange() {
            const displayBasePriceEl = document.getElementById("displayBasePrice");
            const priceInputEl = document.getElementById("inputPrice");
            const minWarningEl = document.getElementById("minWarning");
            if (displayBasePriceEl) {
                displayBasePriceEl.textContent = "Rp " + basePrice.toLocaleString("id-ID");
            }
            if (priceInputEl) {
                priceInputEl.value = basePrice.toLocaleString("id-ID");
            }
            if (minWarningEl) {
                minWarningEl.textContent = "* Minimal DP " + dpPercent + "% (Rp " + minDP.toLocaleString("id-ID") + ")";
            }
            handlePaymentTypeChange();
            updateReferralDiscountDetail();
        }

        const fallbackBankConfig = {
            "BCA": { number: "8920129301", holder: "PT Dialogika Indonesia" },
            "BCA Syariah": { number: "8920129301", holder: "PT Dialogika Indonesia" },
            "BSI": { number: "8920129301", holder: "PT Dialogika Indonesia" },
            "BRI": { number: "8920129301", holder: "PT Dialogika Indonesia" },
            "SMBC": { number: "8920129301", holder: "PT Dialogika Indonesia" }
        };

        let bankConfig = fallbackBankConfig;
        let referralConfig = [];
        let currentReferralCode = "";
        let currentReferralIndex = -1;

        let countdownInterval = null;
        let countdownSeconds = 0;
        let invoiceExpired = false;
        let uploadedProofDataUrl = "";
        let uploadedProofUrl = "";
        let uploadedProofName = "";
        let uploadInProgress = false;
        let pendingProofDataUrl = "";

        async function waitForInvoiceFirestoreTools() {
            if (window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc) return true;
            let attempts = 0;
            while (!(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc) && attempts < 20) {
                await new Promise(function (resolve) { return setTimeout(resolve, 250); });
                attempts++;
            }
            return !!(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc);
        }

        async function computeReferralUsedFromInvoices(code) {
            const normalized = String(code || "").trim().toUpperCase();
            if (!normalized) return null;
            try {
                const ready = await waitForInvoiceFirestoreTools();
                if (!ready || !(window.dlgInvoiceDb && window.dlgInvoiceCollection && window.dlgInvoiceGetDocs)) {
                    return null;
                }
                const snap = await window.dlgInvoiceGetDocs(window.dlgInvoiceCollection(window.dlgInvoiceDb, "invoices"));
                let used = 0;
                snap.forEach(function (docSnap) {
                    const d = docSnap.data() || {};
                    const codeInv = String(d.referralCode || "").trim().toUpperCase();
                    if (!codeInv || codeInv !== normalized) return;
                    const isPaid = (typeof d.paidAtMs === "number" && d.paidAtMs > 0) ||
                        (typeof d.paidAmount === "number" && d.paidAmount > 0);
                    if (isPaid) used++;
                });
                return used;
            } catch (e) {
                return null;
            }
        }

        async function waitForInvoiceStorageTools() {
            if (window.dlgInvoiceStorage && window.dlgInvoiceStorageRef && window.dlgInvoiceUploadBytes && window.dlgInvoiceGetDownloadURL) return true;
            let attempts = 0;
            while (!(window.dlgInvoiceStorage && window.dlgInvoiceStorageRef && window.dlgInvoiceUploadBytes && window.dlgInvoiceGetDownloadURL) && attempts < 20) {
                await new Promise(function (resolve) { return setTimeout(resolve, 250); });
                attempts++;
            }
            return !!(window.dlgInvoiceStorage && window.dlgInvoiceStorageRef && window.dlgInvoiceUploadBytes && window.dlgInvoiceGetDownloadURL);
        }

        function escapeHtml(value) {
            return String(value).replace(/[&<>"']/g, function (m) {
                return ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" })[m];
            });
        }

        function populateBankOptionsFromConfig() {
            const bankSelect = document.getElementById('bankOption');
            if (!bankSelect) return;
            const selected = bankSelect.value || "";
            const keys = Object.keys(bankConfig || {});
            if (!keys.length) return;
            bankSelect.innerHTML = keys.map(function (k) {
                const safe = escapeHtml(k);
                return '<option value="' + safe + '">' + safe + '</option>';
            }).join("");
            if (selected && keys.indexOf(selected) >= 0) {
                bankSelect.value = selected;
            } else {
                bankSelect.value = keys[0];
            }
        }

        async function initBankAndReferralConfig() {
            try {
                await waitForInvoiceFirestoreTools();
                const loadedBankMap = await loadBanksForInvoice();
                if (loadedBankMap && typeof loadedBankMap === "object") {
                    bankConfig = loadedBankMap;
                } else {
                    bankConfig = fallbackBankConfig;
                }
                const loadedReferrals = await loadReferralsForInvoice();
                referralConfig = Array.isArray(loadedReferrals) ? loadedReferrals : [];
                populateBankOptionsFromConfig();
                handleBankChange();
            } catch (e) {
                bankConfig = fallbackBankConfig;
                referralConfig = [];
                populateBankOptionsFromConfig();
                handleBankChange();
            }
        }

        function formatNumberWithDots(value) {
            const numeric = value.toString().replace(/\D/g, '');
            if (!numeric) return '';
            return numeric.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function parseFormattedNumber(value) {
            const numeric = value.toString().replace(/\D/g, '');
            return numeric ? parseInt(numeric, 10) : 0;
        }

        function formatCurrencyIdInt(value) {
            try {
                const n = typeof value === "number" ? value : parseInt(String(value).replace(/\D/g, ''), 10) || 0;
                return "Rp " + n.toLocaleString("id-ID");
            } catch (e) {
                return "Rp 0";
            }
        }

        function setupInvoiceDetailsAccordion() {
            const toggle = document.getElementById('invoiceDetailsToggle');
            const content = document.getElementById('invoiceDetailsContent');
            const icon = document.getElementById('invoiceDetailsIcon');
            if (!toggle || !content || !icon) return;
            toggle.addEventListener('click', function () {
                const isHidden = content.classList.contains('hidden');
                if (isHidden) {
                    content.classList.remove('hidden');
                    icon.textContent = "−";
                } else {
                    content.classList.add('hidden');
                    icon.textContent = "+";
                }
            });
        }

        function renderInvoiceProductDetails(product, productName) {
            const wrapper = document.getElementById('invoiceDetailsWrapper');
            const loadingEl = document.getElementById('invoiceDetailsLoading');
            const curriculumBlock = document.getElementById('invoiceCurriculumBlock');
            const curriculumList = document.getElementById('invoiceCurriculumList');
            const featuresBlock = document.getElementById('invoiceFeaturesBlock');
            const featuresList = document.getElementById('invoiceFeaturesList');
            const specsBlock = document.getElementById('invoiceSpecificationsBlock');
            const specsList = document.getElementById('invoiceSpecificationsList');
            const subtitleEl = document.getElementById('invoiceDetailsSubtitle');
            if (!wrapper) return;
            if (subtitleEl && productName) {
                subtitleEl.textContent = productName;
            }
            if (loadingEl) {
                loadingEl.classList.add('hidden');
            }
            if (!product) {
                if (loadingEl) {
                    loadingEl.textContent = "Detail program belum tersedia.";
                    loadingEl.classList.remove('hidden');
                }
                if (curriculumBlock) curriculumBlock.classList.add('hidden');
                if (featuresBlock) featuresBlock.classList.add('hidden');
                if (specsBlock) specsBlock.classList.add('hidden');
                return;
            }
            const materials = Array.isArray(product.materials) ? product.materials : [];
            const features = Array.isArray(product.features) ? product.features : [];
            const specifications = Array.isArray(product.specifications) ? product.specifications : [];
            if (curriculumBlock && curriculumList) {
                curriculumList.innerHTML = materials.map(function (item) {
                    const order = String(item.order || "").trim();
                    const title = String(item.title || "").trim();
                    const desc = String(item.description || "").trim();
                    const label = order ? order + ". " + title : title;
                    if (desc) {
                        return "<li><span class=\"font-semibold\">" + label + "</span><br><span class=\"text-[12px] text-slate-500\">" + desc + "</span></li>";
                    }
                    return "<li><span class=\"font-semibold\">" + label + "</span></li>";
                }).join("");
                if (materials.length) {
                    curriculumBlock.classList.remove('hidden');
                } else {
                    curriculumBlock.classList.add('hidden');
                }
            }
            if (featuresBlock && featuresList) {
                featuresList.innerHTML = features.map(function (feat) {
                    const label = String(feat.label || "").trim() || "-";
                    const type = String(feat.type || "").toLowerCase();
                    let valueLabel = "";
                    if (type === "boolean") {
                        valueLabel = feat.value ? "Ya" : "Tidak";
                    } else {
                        valueLabel = String(feat.value || "").trim();
                    }
                    if (!valueLabel) valueLabel = "-";
                    return "<li class=\"flex justify-between gap-4\"><span class=\"font-semibold\">" + label + "</span><span class=\"text-[12px] text-slate-600\">" + valueLabel + "</span></li>";
                }).join("");
                if (features.length) {
                    featuresBlock.classList.remove('hidden');
                } else {
                    featuresBlock.classList.add('hidden');
                }
            }
            if (specsBlock && specsList) {
                specsList.innerHTML = specifications.map(function (spec) {
                    const text = String(spec || "").trim();
                    return "<li>" + text + "</li>";
                }).join("");
                if (specifications.length) {
                    specsBlock.classList.remove('hidden');
                } else {
                    specsBlock.classList.add('hidden');
                }
            }
        }

        async function initProductDetailsForInvoice() {
            const wrapper = document.getElementById('invoiceDetailsWrapper');
            if (!wrapper) return;
            const productId = invoiceSettings && invoiceSettings.productId ? String(invoiceSettings.productId).trim() : "";
            const productName = invoiceSettings && (invoiceSettings.productName || invoiceSettings.className) ? String(invoiceSettings.productName || invoiceSettings.className).trim() : "";
            const invoiceMaterials = invoiceSettings && Array.isArray(invoiceSettings.productMaterials) ? invoiceSettings.productMaterials : [];
            const invoiceFeatures = invoiceSettings && Array.isArray(invoiceSettings.productFeatures) ? invoiceSettings.productFeatures : [];
            const invoiceSpecifications = invoiceSettings && Array.isArray(invoiceSettings.productSpecifications) ? invoiceSettings.productSpecifications : [];
            if (invoiceMaterials.length || invoiceFeatures.length || invoiceSpecifications.length) {
                renderInvoiceProductDetails({
                    materials: invoiceMaterials,
                    features: invoiceFeatures,
                    specifications: invoiceSpecifications
                }, productName);
                return;
            }
            if (!productId) {
                renderInvoiceProductDetails(null, productName);
                return;
            }
            try {
                const ready = await waitForInvoiceFirestoreTools();
                if (!ready || !(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc)) {
                    renderInvoiceProductDetails(null, productName);
                    return;
                }
                const ref = window.dlgInvoiceDoc(window.dlgInvoiceDb, "products", productId);
                const snap = await window.dlgInvoiceGetDoc(ref);
                if (!snap.exists()) {
                    renderInvoiceProductDetails(null, productName);
                    return;
                }
                const data = snap.data() || {};
                renderInvoiceProductDetails(data, data.name || productName);
            } catch (e) {
                renderInvoiceProductDetails(null, productName);
            }
        }

        function updateReferralDiscountDetail() {
            const block = document.getElementById('invoiceReferralBlock');
            const valueEl = document.getElementById('invoiceReferralValue');
            if (!block || !valueEl) return;
            if (appliedReferralDiscount && appliedReferralDiscount > 0) {
                valueEl.textContent = formatCurrencyIdInt(appliedReferralDiscount);
                block.classList.remove('hidden');
            } else {
                valueEl.textContent = "";
                block.classList.add('hidden');
            }
        }

        function handleAmountInputChange() {
            const input = document.getElementById('amountPaid');
            if (!input) return;
            const numeric = parseFormattedNumber(input.value);
            input.value = numeric ? formatNumberWithDots(numeric) : '';
        }

        // Logic 1: Payment Type Changes
        function handlePaymentTypeChange() {
            const type = document.getElementById('paymentType').value;
            const amountInput = document.getElementById('amountPaid');
            const minWarning = document.getElementById('minWarning');

            if(type === 'full') {
                amountInput.value = formatNumberWithDots(basePrice);
                amountInput.readOnly = true;
                amountInput.classList.add('disabled-input');
                minWarning.classList.add('hidden');
            } else {
                amountInput.value = formatNumberWithDots(minDP);
                amountInput.readOnly = false;
                amountInput.classList.remove('disabled-input');
                minWarning.classList.remove('hidden');
                amountInput.focus();
            }
        }

        // Logic 2: Payment Method Changes
        function handleMethodChange() {
            const method = document.getElementById('paymentMethod').value;
            const sectionTransfer = document.getElementById('sectionTransfer');
            const sectionCash = document.getElementById('sectionCash');
            const mainBtn = document.getElementById('mainBtn');
            const btnText = document.getElementById('btnText');

            if(method === 'Transfer Bank') {
                sectionTransfer.classList.remove('hidden');
                sectionCash.classList.add('hidden');
                btnText.innerText = "CONFIRM DEAL NOW";
                mainBtn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-[1.5rem] text-lg shadow-xl shadow-blue-200 active:scale-[0.98] transition-all flex items-center justify-center gap-3";
                handleBankChange();
            } else if(method === 'Cash') {
                sectionTransfer.classList.add('hidden');
                sectionCash.classList.remove('hidden');
                btnText.innerText = "SCHEDULE THIS MEETING";
                mainBtn.className = "w-full bg-amber-600 hover:bg-amber-700 text-white font-black py-5 rounded-[1.5rem] text-lg shadow-xl shadow-amber-200 active:scale-[0.98] transition-all flex items-center justify-center gap-3";
            }

            updateConfirmButtonState();
        }

        function updateConfirmButtonState() {
            const methodEl = document.getElementById('paymentMethod');
            const mainBtn = document.getElementById('mainBtn');
            const fileInput = document.getElementById('fileUpload');
            if (!methodEl || !mainBtn || !fileInput) return;

            if (invoiceExpired) {
                mainBtn.disabled = true;
                mainBtn.classList.add('opacity-60', 'cursor-not-allowed');
                return;
            }

            const method = methodEl.value;
            if (method === 'Transfer Bank') {
                const hasFile = fileInput.files && fileInput.files.length > 0;
                const shouldDisable = !hasFile || uploadInProgress;
                mainBtn.disabled = shouldDisable;
                if (shouldDisable) {
                    mainBtn.classList.add('opacity-60', 'cursor-not-allowed');
                } else {
                    mainBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                }
            } else {
                mainBtn.disabled = false;
                mainBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        }

        function handleBankChange() {
            const bankSelect = document.getElementById('bankOption');
            const infoEl = document.getElementById('displayBankInfo');
            const holderEl = document.getElementById('displayAccountHolder');
            const copyBtn = document.getElementById('copyRekeningBtn');

            if (!bankSelect || !infoEl || !holderEl || !copyBtn) return;

            const key = bankSelect.value;
            const cfg = bankConfig[key];
            if (!cfg) {
                infoEl.innerText = key || "-";
                holderEl.innerText = "-";
                copyBtn.dataset.account = "";
                initBankAndReferralConfig();
                return;
            }

            infoEl.innerText = `${key} - ${cfg.number}`;
            holderEl.innerText = cfg.holder;
            copyBtn.dataset.account = cfg.number;
        }

        function copyRekening() {
            const btn = document.getElementById('copyRekeningBtn');
            if (!btn) return;
            const number = btn.dataset.account || '';
            if (!number) return;

            const onSuccess = () => {
                const original = btn.innerText;
                btn.innerText = "Copied";
                setTimeout(() => { btn.innerText = original; }, 1500);
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(number).then(onSuccess).catch(() => {
                    alert("Gagal menyalin nomor rekening.");
                });
            } else {
                const temp = document.createElement('input');
                temp.value = number;
                document.body.appendChild(temp);
                temp.select();
                try { document.execCommand('copy'); } catch (e) {}
                document.body.removeChild(temp);
                onSuccess();
            }
        }

        async function checkReferral() {
            const input = document.getElementById('referralCode');
            const msgEl = document.getElementById('referralMessage');
            if (!input || !msgEl) return;

            const code = input.value.trim().toUpperCase();
            msgEl.classList.remove('hidden');

            currentReferralCode = "";
            currentReferralIndex = -1;

            resetReferralDiscount();

            if (!code) {
                msgEl.textContent = "Masukkan kode referral jika ada.";
                msgEl.classList.remove('text-green-600');
                msgEl.classList.add('text-slate-500');
                return;
            }

            if (!Array.isArray(referralConfig) || !referralConfig.length) {
                try {
                    await waitForInvoiceFirestoreTools();
                    const loaded = await loadReferralsForInvoice();
                    referralConfig = Array.isArray(loaded) ? loaded : [];
                } catch (e) {
                    referralConfig = [];
                }
            }

            const foundIndex = referralConfig.findIndex(function (r) {
                const refCode = (r && r.code ? String(r.code) : "").trim().toUpperCase();
                return refCode === code;
            });
            const found = foundIndex >= 0 ? referralConfig[foundIndex] : null;
            if (!found) {
                msgEl.textContent = "Kode referral tidak terdaftar.";
                msgEl.classList.remove('text-green-600');
                msgEl.classList.add('text-red-600');
                return;
            }

            const currentProductName = (invoiceSettings && invoiceSettings.productName
                ? String(invoiceSettings.productName).trim().toLowerCase()
                : "");
            const allowedProducts = Array.isArray(found.productNames) ? found.productNames.map(function (n) { return String(n || "").trim().toLowerCase(); }) : [];
            if (allowedProducts.length && currentProductName) {
                const isAllowed = allowedProducts.indexOf(currentProductName) !== -1;
                if (!isAllowed) {
                    msgEl.textContent = "Kode referral tidak berlaku untuk program ini.";
                    msgEl.classList.remove('text-green-600');
                    msgEl.classList.add('text-red-600');
                    return;
                }
            }

            const max = found.maxUsage || 0;
            let used = found.usedCount || 0;
            const usedFromInvoices = await computeReferralUsedFromInvoices(code);
            if (typeof usedFromInvoices === "number") {
                used = usedFromInvoices;
            }
            const remaining = Math.max(max - used, 0);

            if (max && remaining <= 0) {
                msgEl.textContent = "Kode valid, tapi kuota pemakaian sudah habis.";
                msgEl.classList.remove('text-green-600', 'text-slate-500');
                msgEl.classList.add('text-red-600');
                return;
            }

            let extra = "";
            if (found.functionType === "discount") {
                const percent = typeof found.discountPercent === "number" ? found.discountPercent : 0;
                const fixedAmount = typeof found.discountAmount === "number" ? found.discountAmount : 0;
                let discountPreview = 0;
                if (fixedAmount > 0) {
                    discountPreview = fixedAmount;
                } else if (percent > 0) {
                    discountPreview = Math.round(originalBasePrice * (percent / 100));
                }
                if (discountPreview > originalBasePrice) discountPreview = originalBasePrice;
                if (discountPreview > 0) {
                    extra = " Diskon Rp " + discountPreview.toLocaleString("id-ID") + ".";
                }
            } else if (found.functionType) {
                extra = " (" + found.functionType + ").";
            }

            msgEl.textContent = "Kode valid." + extra + " Sisa " + remaining + " dari " + max + " kali pemakaian.";
            msgEl.classList.remove('text-red-600', 'text-slate-500');
            msgEl.classList.add('text-green-600');
            currentReferralCode = code;
            currentReferralIndex = foundIndex;
            applyDiscountFromReferralItem(found);
        }

        async function applyReferralToInvoice() {
            if (!currentReferralCode) return;
            try {
                const code = currentReferralCode;
                let list = referralConfig;
                if (!Array.isArray(list)) {
                    list = await loadReferralsForInvoice();
                }
                const idx = currentReferralIndex >= 0 ? currentReferralIndex : list.findIndex(function (r) {
                    const refCode = (r && r.code ? String(r.code) : "").trim().toUpperCase();
                    return refCode === String(code).trim().toUpperCase();
                });
                if (idx >= 0) {
                    const item = list[idx];
                    const max = item.maxUsage || 0;
                    const used = item.usedCount || 0;
                    if (!max || used < max) {
                        item.usedCount = used + 1;
                        list[idx] = item;
                        localStorage.setItem(STORAGE_KEY_REFERRALS, JSON.stringify(list));
                        referralConfig = list;
                    }
                }
                if (invoiceIdFromUrl && window.dlgInvoiceDb && window.dlgInvoiceDoc && (window.dlgInvoiceSetDoc || window.dlgInvoiceUpdateDoc)) {
                    const ref = window.dlgInvoiceDoc(window.dlgInvoiceDb, "invoices", invoiceIdFromUrl);
                    const payload = { referralCode: code, referralUsedAtMs: Date.now() };
                    if (window.dlgInvoiceSetDoc) {
                        await window.dlgInvoiceSetDoc(ref, payload, { merge: true });
                    } else {
                        await window.dlgInvoiceUpdateDoc(ref, payload);
                    }
                }
            } catch (e) {
            }
        }

        function resetReferralDiscount() {
            appliedReferralDiscount = 0;
            basePrice = originalBasePrice;
            minDP = Math.round(basePrice * dpPercent / 100);
            updatePriceFieldsAfterBasePriceChange();
        }

        function applyDiscountFromReferralItem(item) {
            if (!item || item.functionType !== "discount") {
                return;
            }
            const percent = typeof item.discountPercent === "number" ? item.discountPercent : 0;
            const fixedAmount = typeof item.discountAmount === "number" ? item.discountAmount : 0;
            let discount = 0;
            if (fixedAmount > 0) {
                discount = fixedAmount;
            } else if (percent > 0) {
                discount = Math.round(originalBasePrice * (percent / 100));
            }
            if (discount <= 0) {
                return;
            }
            if (discount >= originalBasePrice) {
                discount = originalBasePrice;
            }
            appliedReferralDiscount = discount;
            basePrice = originalBasePrice - discount;
            minDP = Math.round(basePrice * dpPercent / 100);
            updatePriceFieldsAfterBasePriceChange();
        }

        function setInvoiceExpiredUI() {
            invoiceExpired = true;
            clearCountdown();
            const timerEl = document.getElementById('countdownTimer');
            if (timerEl) {
                timerEl.textContent = "00:00";
            }

            const mainBtn = document.getElementById('mainBtn');
            const btnText = document.getElementById('btnText');
            if (mainBtn) {
                mainBtn.disabled = true;
                mainBtn.classList.add('opacity-60', 'cursor-not-allowed');
            }
            if (btnText) {
                btnText.innerText = "INVOICE EXPIRED";
            }

            const toDisableIds = [
                "referralCode",
                "paymentType",
                "amountPaid",
                "paymentMethod",
                "bankOption",
                "fileUpload"
            ];
            toDisableIds.forEach(function (id) {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = true;
                }
            });
        }

        function startCountdownFromTotalSeconds(totalSeconds) {
            const timerEl = document.getElementById('countdownTimer');
            if (!timerEl) return;

            countdownSeconds = Math.max(parseInt(totalSeconds, 10) || 0, 0);
            clearCountdown();

            const updateCountdownDisplay = function () {
                if (!timerEl) return;
                const m = String(Math.floor(countdownSeconds / 60)).padStart(2, '0');
                const s = String(countdownSeconds % 60).padStart(2, '0');
                timerEl.textContent = m + ":" + s;
            };

            updateCountdownDisplay();

            countdownInterval = setInterval(function () {
                countdownSeconds--;
                if (countdownSeconds <= 0) {
                    setInvoiceExpiredUI();
                    return;
                }
                updateCountdownDisplay();
            }, 1000);
        }

        function startCountdown(minutes) {
            startCountdownFromTotalSeconds((parseInt(minutes, 10) || 0) * 60);
        }

        function clearCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function initCountdownFromInvoice() {
            const timerEl = document.getElementById('countdownTimer');
            if (!timerEl) return;

            const deadlineMinutes = typeof invoiceSettings.deadlineMinutes === "number" ? invoiceSettings.deadlineMinutes : 0;
            const startedAtMs = typeof invoiceSettings.startedAtMs === "number" ? invoiceSettings.startedAtMs : 0;
            if (!deadlineMinutes || !startedAtMs) {
                timerEl.textContent = "00:00";
                return;
            }

            const expiryMs = startedAtMs + deadlineMinutes * 60 * 1000;
            const now = Date.now();
            if (now >= expiryMs) {
                setInvoiceExpiredUI();
                return;
            }

            const remainingSeconds = Math.floor((expiryMs - now) / 1000);
            startCountdownFromTotalSeconds(remainingSeconds);
        }

        async function uploadFileToStorage(file, folder) {
            const ready = await waitForInvoiceStorageTools();
            if (!ready || !file) return "";
            const cleanName = String(file.name || "bukti-transfer").replace(/[^a-zA-Z0-9._-]/g, "_");
            const path = (folder || "payment-proofs") + "/" + Date.now() + "-" + cleanName;
            const fileRef = window.dlgInvoiceStorageRef(window.dlgInvoiceStorage, path);
            await window.dlgInvoiceUploadBytes(fileRef, file);
            return await window.dlgInvoiceGetDownloadURL(fileRef);
        }

        function setUploadPreview(file, dataUrl, forceShow) {
            const preview = document.getElementById('uploadPreview');
            const previewImg = document.getElementById('uploadPreviewImage');
            const previewName = document.getElementById('uploadPreviewName');
            const placeholder = document.getElementById('uploadPlaceholder');
            if (!preview || !previewImg || !previewName) return;
            if (!file || (!dataUrl && !forceShow)) {
                preview.classList.add('hidden');
                previewImg.src = "";
                previewName.textContent = "";
                previewImg.classList.remove('hidden');
                if (placeholder) placeholder.classList.remove('hidden');
                return;
            }
            previewImg.src = dataUrl;
            previewName.textContent = file.name || "";
            preview.classList.remove('hidden');
            if (!dataUrl) {
                previewImg.classList.add('hidden');
            } else {
                previewImg.classList.remove('hidden');
            }
            if (placeholder) placeholder.classList.add('hidden');
        }

        function setupUploadPreviewModal() {
            const previewImg = document.getElementById('uploadPreviewImage');
            const modal = document.getElementById('uploadPreviewModal');
            const modalImg = document.getElementById('uploadPreviewModalImage');
            if (!previewImg || !modal || !modalImg) return;
            previewImg.addEventListener('click', function () {
                if (!previewImg.src) return;
                modalImg.src = previewImg.src;
                modal.classList.remove('hidden');
            });
            modal.addEventListener('click', function () {
                modal.classList.add('hidden');
            });
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    modal.classList.add('hidden');
                }
            });
        }

        function setUploadSpinner(visible) {
            const spinner = document.getElementById('uploadSpinner');
            if (!spinner) return;
            if (visible) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        function readFileAsDataUrl(file) {
            return new Promise(function (resolve) {
                const reader = new FileReader();
                reader.onload = function (e) { resolve(e.target.result || ""); };
                reader.onerror = function () { resolve(""); };
                reader.readAsDataURL(file);
            });
        }

        // Logic 3: File Upload Feedback
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileUpload');
            const successMsg = document.getElementById('uploadSuccess');
            if (!fileInput || !successMsg) return;
            const successText = successMsg.querySelector('p');

            const file = fileInput.files && fileInput.files.length > 0 ? fileInput.files[0] : null;
            uploadedProofDataUrl = "";
            uploadedProofUrl = "";
            uploadedProofName = "";
            pendingProofDataUrl = "";
            setUploadPreview(null, "");

            if (file) {
                successMsg.classList.remove('hidden');
                if (successText) {
                    successText.textContent = "Mengupload bukti transfer...";
                }
                const isImage = file.type && file.type.startsWith("image/");
                if (isImage) {
                    pendingProofDataUrl = await readFileAsDataUrl(file);
                }
                try {
                    uploadInProgress = true;
                    setUploadSpinner(true);
                    updateConfirmButtonState();
                    uploadedProofUrl = await uploadFileToStorage(file, "payment-proofs");
                    uploadedProofName = file.name || "";
                    uploadedProofDataUrl = pendingProofDataUrl;
                    if (isImage) {
                        setUploadPreview(file, pendingProofDataUrl, true);
                    } else {
                        setUploadPreview(file, "", true);
                    }
                    if (successText) {
                        successText.textContent = "Berhasil diupload! Segera pencet tombol di bawah untuk konfirmasi ke admin.";
                    }
                } catch (e) {
                    if (successText) {
                        successText.textContent = "Gagal mengupload. Silakan coba lagi.";
                    }
                    uploadedProofUrl = "";
                    uploadedProofDataUrl = "";
                    pendingProofDataUrl = "";
                    setUploadPreview(null, "");
                } finally {
                    uploadInProgress = false;
                    setUploadSpinner(false);
                    updateConfirmButtonState();
                }
                lucide.createIcons();
            } else {
                successMsg.classList.add('hidden');
                uploadedProofDataUrl = "";
                uploadedProofUrl = "";
                uploadedProofName = "";
                pendingProofDataUrl = "";
                setUploadPreview(null, "");
                uploadInProgress = false;
                setUploadSpinner(false);
            }
            updateConfirmButtonState();
        }

        // Logic 4: Submission
        async function submitDeal() {
            if (invoiceExpired) {
                return;
            }
            const method = document.getElementById('paymentMethod').value;
            const amountInputEl = document.getElementById('amountPaid');
            const amount = parseFormattedNumber(amountInputEl.value);
            
            if(document.getElementById('paymentType').value === 'dp' && amount < minDP) {
                alert("Maaf, minimal pembayaran DP adalah 35% (Rp " + minDP.toLocaleString('id-ID') + ")");
                return;
            }

            await applyReferralToInvoice();

            if(method === 'Cash') {
                const waUrl = `https://wa.me/628123456789?text=Halo%20Admin%20Dialogika,%20saya%20ingin%20janjian%20pembayaran%20CASH%20untuk%20kelas%20${encodeURIComponent(document.getElementById('className').innerText)}`;
                window.open(waUrl, '_blank');
            } else {
                const fileInput = document.getElementById('fileUpload');
                if(!fileInput || fileInput.files.length === 0) {
                    alert("Mohon upload bukti transfer Anda terlebih dahulu.");
                    return;
                }
                if (uploadInProgress) {
                    alert("Upload bukti transfer masih berlangsung. Mohon tunggu.");
                    return;
                }
                if (!uploadedProofUrl) {
                    try {
                        uploadedProofUrl = await uploadFileToStorage(fileInput.files[0], "payment-proofs");
                    } catch (e) {
                        alert("Upload bukti transfer gagal. Silakan coba lagi.");
                        return;
                    }
                }

                if (invoiceIdFromUrl && window.dlgInvoiceDb && window.dlgInvoiceDoc && (window.dlgInvoiceSetDoc || window.dlgInvoiceUpdateDoc)) {
                    try {
                        const ref = window.dlgInvoiceDoc(window.dlgInvoiceDb, "invoices", invoiceIdFromUrl);
                        const payload = {
                            leadName: (document.getElementById('leadName') || {}).textContent || "",
                            className: (document.getElementById('className') || {}).textContent || "",
                            productId: (invoiceSettings && invoiceSettings.productId) ? String(invoiceSettings.productId) : "",
                            productName: (invoiceSettings && (invoiceSettings.productName || invoiceSettings.className)) ? String(invoiceSettings.productName || invoiceSettings.className) : "",
                            paidAmount: amount,
                            paidAmountFormatted: amountInputEl.value,
                            paidAtMs: Date.now(),
                            paymentMethod: method,
                            bankName: (document.getElementById('bankOption') || {}).value || "",
                            paymentType: document.getElementById('paymentType').value,
                            referralCode: currentReferralCode || "",
                            originalBasePrice: originalBasePrice,
                            finalBasePrice: basePrice,
                            discountAmount: appliedReferralDiscount,
                            transferProofUrl: uploadedProofUrl || "",
                            verificationStatus: "not_verified"
                        };
                        if (window.dlgInvoiceSetDoc) {
                            await window.dlgInvoiceSetDoc(ref, payload, { merge: true });
                        } else {
                            await window.dlgInvoiceUpdateDoc(ref, payload);
                        }
                    } catch (e) {
                    }
                }

                const receiptData = {
                    invoiceNumber: (document.getElementById('invoiceNumber') || {}).textContent || "",
                    leadName: (document.getElementById('leadName') || {}).textContent || "",
                    className: (document.getElementById('className') || {}).textContent || "",
                    productId: (invoiceSettings && invoiceSettings.productId) ? String(invoiceSettings.productId) : "",
                    productName: (invoiceSettings && (invoiceSettings.productName || invoiceSettings.className)) ? String(invoiceSettings.productName || invoiceSettings.className) : "",
                    paymentType: document.getElementById('paymentType').value,
                    amountPaid: amount,
                    amountPaidFormatted: amountInputEl.value,
                    paymentMethod: method,
                    bankName: (document.getElementById('bankOption') || {}).value || "",
                    transferProofDataUrl: uploadedProofDataUrl || "",
                    transferProofUrl: uploadedProofUrl || "",
                    createdAtMs: Date.now(),
                    referralCode: currentReferralCode || "",
                    originalBasePrice: originalBasePrice,
                    finalBasePrice: basePrice,
                    discountAmount: appliedReferralDiscount
                };

                try {
                    sessionStorage.setItem('dlg_invoice_receipt', JSON.stringify(receiptData));
                } catch (e) {
                }

                let targetUrl = "receipt.html";
                if (invoiceIdFromUrl) {
                    targetUrl += "?invoiceId=" + encodeURIComponent(invoiceIdFromUrl);
                }
                window.location.href = targetUrl;
            }
        }

        async function tryLoadInvoiceFromFirestore() {
            if (!invoiceIdFromUrl) return;
            let attempts = 0;
            while (!(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc) && attempts < 10) {
                await new Promise(function (resolve) { return setTimeout(resolve, 500); });
                attempts++;
            }
            if (!(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc)) return;
            try {
                const ref = window.dlgInvoiceDoc(window.dlgInvoiceDb, "invoices", invoiceIdFromUrl);
                const snap = await window.dlgInvoiceGetDoc(ref);
                if (!snap.exists()) return;
                const d = snap.data() || {};
                let startedAtMs = typeof d.startedAtMs === "number" ? d.startedAtMs : 0;
                const deadlineMinutesFromDoc = typeof d.deadlineMinutes === "number" ? d.deadlineMinutes : invoiceSettings.deadlineMinutes;
                if (!startedAtMs && deadlineMinutesFromDoc > 0 && window.dlgInvoiceSetDoc) {
                    try {
                        const nowMs = Date.now();
                        await window.dlgInvoiceSetDoc(ref, { startedAtMs: nowMs }, { merge: true });
                        startedAtMs = nowMs;
                    } catch (e) {
                    }
                }
                const merged = Object.assign({}, invoiceSettings, {
                    leadName: d.leadName || invoiceSettings.leadName,
                    className: d.className || invoiceSettings.className,
                    batchLabel: d.batchLabel || invoiceSettings.batchLabel,
                    classType: d.classType || invoiceSettings.classType,
                    location: d.location || invoiceSettings.location,
                    seatsLeft: typeof d.seatsLeft === "number" ? d.seatsLeft : invoiceSettings.seatsLeft,
                    deadlineMinutes: typeof d.deadlineMinutes === "number" ? d.deadlineMinutes : invoiceSettings.deadlineMinutes,
                    basePrice: typeof d.basePrice === "number" ? d.basePrice : invoiceSettings.basePrice,
                    dpPercent: typeof d.dpPercent === "number" ? d.dpPercent : invoiceSettings.dpPercent,
                    startedAtMs: startedAtMs,
                    productId: d.productId || invoiceSettings.productId,
                    productName: d.productName || invoiceSettings.productName || (d.className || invoiceSettings.className),
                    productMaterials: Array.isArray(d.productMaterials) ? d.productMaterials : (invoiceSettings.productMaterials || []),
                    productFeatures: Array.isArray(d.productFeatures) ? d.productFeatures : (invoiceSettings.productFeatures || []),
                    productSpecifications: Array.isArray(d.productSpecifications) ? d.productSpecifications : (invoiceSettings.productSpecifications || [])
                });
                invoiceSettings = merged;
                basePrice = invoiceSettings.basePrice || 2500000;
                dpPercent = invoiceSettings.dpPercent || 35;
                minDP = Math.round(basePrice * dpPercent / 100);
                originalBasePrice = basePrice;
                appliedReferralDiscount = 0;
                const invoiceNumber = typeof d.invoiceNumber === "string" && d.invoiceNumber ? d.invoiceNumber : null;
                renderInvoice(invoiceSettings, invoiceNumber);
                handlePaymentTypeChange();
                handleBankChange();
                handleMethodChange();
            } catch (e) {
            }
        }

        function printInvoice() {
            window.print();
        }

        (async function () {
            renderInvoice(invoiceSettings);
            handlePaymentTypeChange();
            updateConfirmButtonState();
            setupInvoiceDetailsAccordion();
            updateReferralDiscountDetail();
            await initBankAndReferralConfig();
            await tryLoadInvoiceFromFirestore();
            initCountdownFromInvoice();
            handleMethodChange();
            handleBankChange();
            setupUploadPreviewModal();
            await initProductDetailsForInvoice();
            updateReferralDiscountDetail();
        })();
    </script>
</body>
</html>
