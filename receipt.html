<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Pembayaran | Dialogika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .btn-dlg-green {
            background: linear-gradient(to bottom, #006a4e 5%, #002a1f 100%);
            box-shadow: 0px 5px 16px -6px rgba(114, 4, 207, 1);
            -webkit-box-shadow: 0px 5px 16px -6px rgb(169, 64, 255);
            color: white; border: none; transition: 0.3s;
        }
        .btn-dlg-green:hover {
            background: linear-gradient(to bottom, #002a1f 5%, #006a4e 100%);
            box-shadow: 0px 0px 4px 2px rgba(114, 4, 207, 0.75);
            -webkit-box-shadow: 0px 0px 4px 2px rgba(114, 4, 207, 0.75);
        }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 antialiased">

    <main class="min-h-screen flex items-center justify-center px-4 py-10">
        <div class="w-full max-w-xl space-y-6">
            <div class="bg-white rounded-2xl shadow-md shadow-slate-200/60 border border-slate-200 px-6 py-5 relative overflow-hidden">
                <div class="absolute top-1/2 left-10 right-10 h-px bg-slate-100 -translate-y-1/2 pointer-events-none"></div>
                <div class="relative flex items-center justify-between">
                    <div class="flex-1 flex flex-col items-center gap-2">
                        <div class="w-12 h-12 rounded-2xl bg-blue-600 text-white flex items-center justify-center shadow-lg shadow-blue-200">
                            <i class="bi bi-whatsapp "></i>
                        </div>
                        <div class="text-center">
                            <p class="text-[13px] font-semibold text-slate-900">Confirm Admin</p>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col items-center gap-2">
                        <div class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-400 flex items-center justify-center border border-slate-100">
                            <i class="bi bi-pencil-square"></i>
                        </div>
                        <div class="text-center">
                            <p class="text-[13px] font-semibold text-slate-900">Fill Biodata</p>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col items-center gap-2">
                        <div class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-400 flex items-center justify-center border border-slate-100">
                            <i class="bi bi-person-badge-fill"></i>
                        </div>
                        <div class="text-center">
                            <p class="text-[13px] font-semibold text-slate-900">Join Group</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
                <div class="p-8 space-y-6">
                    <header class="flex items-start justify-between gap-4">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Bukti Pembayaran</p>
                            <h1 class="mt-1 text-xl font-extrabold tracking-tight" id="receiptLeadName">Nama Peserta</h1>
                            <p class="mt-1 text-[11px] font-mono text-slate-400">
                                Invoice <span id="receiptInvoiceNumber" class="font-semibold text-slate-600"></span>
                            </p>
                        </div>
                        <div class="text-right">
                            <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika" class="h-8 w-auto ml-auto">
                            <p class="mt-2 text-[10px] text-slate-400 font-semibold uppercase tracking-[0.25em]" id="receiptDateLabel"></p>
                        </div>
                    </header>

                    <div class="p-4 bg-[#0b2b6a] rounded-2xl text-white" style="box-shadow: 0px 7px 9px -6px rgba(114, 4, 207, 1);">
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.25em]">Kelas Yang Diambil</p>
                        <div class="mt-2 flex items-center justify-between gap-4">
                            <div>
                                <p class="text-sm font-bold" id="receiptClassName">Nama Kelas</p>
                                <p class="text-[11px] text-slate-400 mt-1">Metode: <span id="receiptMethodLabel" class="font-semibold text-white">Transfer Bank</span></p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-[0.25em]">Nominal Bayar</p>
                                <p class="text-[11px] text-slate-400 line-through hidden" id="receiptOriginalPriceLabel">Rp 0</p>
                                <p class="text-lg font-black text-emerald-400" id="receiptAmountLabel">Rp 0</p>
                            </div>
                        </div>
                    </div>

                    <section class="grid grid-cols-2 gap-4 text-sm">
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Tipe Pembayaran</p>
                            <p class="font-semibold text-slate-800" id="receiptPaymentType">Full Payment</p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Metode</p>
                            <p class="font-semibold text-slate-800" id="receiptMethod">Transfer Bank</p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Bank Tujuan</p>
                            <p class="font-semibold text-slate-800" id="receiptBankName">-</p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Kode Referral</p>
                            <p class="font-semibold text-slate-800" id="receiptReferralCode">-</p>
                            
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Status</p>
                            <p class="font-semibold text-amber-600">Menunggu Verifikasi Admin</p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Chat Admin </p>
                            <button id="waConfirmBtn" class="mt-2 inline-flex items-center gap-2 px-3 py-1.5 rounded-full btn-dlg-green text-white text-[10px] font-black uppercase tracking-[0.25em] hover:bg-emerald-600">
                                Konfirmasi Admin
                            </button>
                        </div>
                    </section>

                    <section id="receiptProofSection" class="space-y-3">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Bukti Transfer</p>
                        <div class="rounded-2xl border border-slate-200 overflow-hidden bg-slate-50">
                            <img id="receiptProofImage" src="" alt="Bukti Transfer" class="w-full max-h-80 object-contain bg-slate-900/80">
                        </div>
                    </section>

                    <div id="imageModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
                        <div class="max-w-full max-h-full p-4">
                            <img id="imageModalContent" src="" class="max-h-[90vh] max-w-[90vw] object-contain bg-black">
                        </div>
                    </div>

                    <section id="receiptEmptySection" class="hidden text-center text-xs text-slate-500">
                        <p>Data pembayaran tidak ditemukan.</p>
                        <p class="mt-1">Silakan kembali ke halaman invoice untuk melakukan konfirmasi pembayaran.</p>
                    </section>

                    <section id="receiptDetailsWrapper" class="space-y-4 hidden">
                        <div class="bg-white rounded-[2rem] border border-slate-200 overflow-hidden">
                            <button type="button" id="receiptDetailsToggle" class="w-full flex items-center justify-between px-6 py-4">
                                <div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Details Program</p>
                                    <p id="receiptDetailsSubtitle" class="text-xs text-slate-500 mt-1">Klik untuk melihat rincian program.</p>
                                </div>
                                <span id="receiptDetailsIcon" class="w-8 h-8 rounded-full border border-slate-200 flex items-center justify-center text-lg font-bold text-slate-500">+</span>
                            </button>
                            <div id="receiptDetailsContent" class="border-t border-slate-100 px-6 py-5 space-y-5 text-sm text-slate-800 hidden">
                                <div id="receiptDetailsLoading" class="text-xs text-slate-500">Memuat detail program...</div>
                                <div id="receiptCurriculumBlock" class="space-y-2 hidden">
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Curriculum</p>
                                    <ol id="receiptCurriculumList" class="list-decimal list-inside space-y-1 text-[13px]"></ol>
                                </div>
                                <div id="receiptFeaturesBlock" class="space-y-2 hidden">
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Key Features</p>
                                    <ul id="receiptFeaturesList" class="space-y-1 text-[13px]"></ul>
                                </div>
                                <div id="receiptSpecificationsBlock" class="space-y-2 hidden">
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Specification</p>
                                    <ul id="receiptSpecificationsList" class="space-y-1 text-[13px]"></ul>
                                </div>
                                <div id="receiptReferralBlock" class="space-y-1 hidden">
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Potongan Referral</p>
                                    <p id="receiptReferralValue" class="text-[13px] font-semibold text-emerald-600"></p>
                                </div>
                            </div>
                        </div>
                        <div id="receiptPrintActions" class="flex justify-end gap-3">
                            <button type="button" onclick="openInvoicePage()" class="inline-flex items-center gap-2 px-4 py-3 rounded-full bg-slate-100 text-slate-700 text-[11px] font-black uppercase tracking-[0.25em] border border-slate-200">
                                Cetak Invoice
                            </button>
                            <button type="button" onclick="printReceipt()" class="inline-flex items-center gap-2 px-4 py-3 rounded-full bg-slate-900 text-white text-[11px] font-black uppercase tracking-[0.25em] shadow-lg shadow-slate-300/60">
                                Cetak Bukti Pembayaran
                            </button>
                        </div>
                    </section>

                    <footer class="pt-2 border-t border-dashed border-slate-200 flex items-center justify-between gap-4">
                        <div class="text-[10px] text-slate-500 leading-relaxed">
                            <p>Terima kasih telah mempercayai Dialogika.</p>
                            <p>Admin kami akan menghubungi Anda setelah pembayaran terverifikasi.</p>
                        </div>
                        <a href="invoice.html" class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-200 text-[11px] font-black uppercase tracking-[0.25em] text-slate-700 hover:bg-slate-50">
                            <i data-lucide="arrow-left" class="w-3 h-3"></i>
                            Kembali
                        </a>
                    </footer>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5",
            measurementId: "G-SXN811P3N0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.dlgInvoiceDb = db;
        window.dlgInvoiceDoc = doc;
        window.dlgInvoiceGetDoc = getDoc;
        window.dlgInvoiceUpdateDoc = updateDoc;
        console.log("Firebase initialized in receipt.html");
    </script>

    <script>
        lucide.createIcons();
        let lastReceiptData = null;
        const params = new URLSearchParams(window.location.search);
        const invoiceIdFromUrl = params.get("invoiceId") || "";

        function formatCurrencyId(value) {
            try {
                const n = typeof value === "number" ? value : parseInt(String(value).replace(/\D/g, ''), 10) || 0;
                return "Rp " + n.toLocaleString("id-ID");
            } catch (e) {
                return "Rp 0";
            }
        }

        function loadReceiptFromStorage() {
            let data = null;
            try {
                const raw = sessionStorage.getItem('dlg_invoice_receipt');
                if (raw) {
                    data = JSON.parse(raw);
                }
            } catch (e) {
                data = null;
            }
            return data;
        }

        async function loadReceiptFromFirestore(invoiceId) {
            if (!invoiceId) return null;
            let attempts = 0;
            while (!(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc) && attempts < 10) {
                await new Promise(function (resolve) { return setTimeout(resolve, 500); });
                attempts++;
            }
            if (!(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc)) return null;
            try {
                const ref = window.dlgInvoiceDoc(window.dlgInvoiceDb, "invoices", invoiceId);
                const snap = await window.dlgInvoiceGetDoc(ref);
                if (!snap.exists()) return null;
                const d = snap.data() || {};
                return {
                    invoiceNumber: d.invoiceNumber || "",
                    leadName: d.leadName || "Nama Peserta",
                    className: d.className || "Nama Kelas",
                    productId: d.productId || "",
                    productName: d.productName || "",
                    paymentType: d.paymentType || "full",
                    amountPaid: typeof d.paidAmount === "number" ? d.paidAmount : 0,
                    amountPaidFormatted: d.paidAmountFormatted || "",
                    paymentMethod: d.paymentMethod || "Transfer Bank",
                    bankName: d.bankName || "-",
                        transferProofDataUrl: d.transferProofDataUrl || "",
                        transferProofUrl: d.transferProofUrl || "",
                    createdAtMs: typeof d.paidAtMs === "number" && d.paidAtMs > 0 ? d.paidAtMs : (typeof d.createdAtMs === "number" ? d.createdAtMs : Date.now()),
                    referralCode: d.referralCode || "",
                    originalBasePrice: typeof d.originalBasePrice === "number" ? d.originalBasePrice : (typeof d.basePrice === "number" ? d.basePrice : 0),
                    finalBasePrice: typeof d.finalBasePrice === "number" ? d.finalBasePrice : (typeof d.basePrice === "number" ? d.basePrice : 0),
                    discountAmount: typeof d.discountAmount === "number" ? d.discountAmount : 0
                };
            } catch (e) {
                return null;
            }
        }

        async function renderReceipt() {
            let data = loadReceiptFromStorage();
            if (!data && invoiceIdFromUrl) {
                data = await loadReceiptFromFirestore(invoiceIdFromUrl);
            }
            lastReceiptData = data;

            const leadEl = document.getElementById('receiptLeadName');
            const invoiceEl = document.getElementById('receiptInvoiceNumber');
            const dateLabelEl = document.getElementById('receiptDateLabel');
            const classEl = document.getElementById('receiptClassName');
            const methodLabelEl = document.getElementById('receiptMethodLabel');
            const amountLabelEl = document.getElementById('receiptAmountLabel');
            const paymentTypeEl = document.getElementById('receiptPaymentType');
            const methodEl = document.getElementById('receiptMethod');
            const bankEl = document.getElementById('receiptBankName');
            const referralCodeEl = document.getElementById('receiptReferralCode');
            const originalPriceLabelEl = document.getElementById('receiptOriginalPriceLabel');
            const proofSection = document.getElementById('receiptProofSection');
            const proofImg = document.getElementById('receiptProofImage');
            const emptySection = document.getElementById('receiptEmptySection');
            const detailsWrapper = document.getElementById('receiptDetailsWrapper');

            if (!data) {
                document.title = "Receipt Pembayaran | Dialogika";
                if (proofSection) proofSection.classList.add('hidden');
                if (emptySection) emptySection.classList.remove('hidden');
                if (detailsWrapper) detailsWrapper.classList.add('hidden');
                return;
            }

            const leadName = data.leadName || 'Nama Peserta';
            if (leadEl) leadEl.textContent = leadName;
            document.title = leadName + " | Receipt Pembayaran | Dialogika";
            if (invoiceEl) invoiceEl.textContent = data.invoiceNumber || '-';
            if (classEl) classEl.textContent = data.className || 'Nama Kelas';
            if (methodLabelEl) methodLabelEl.textContent = data.paymentMethod || 'Transfer Bank';
            if (amountLabelEl) {
                const formatted = data.amountPaidFormatted || formatCurrencyId(data.amountPaid || 0);
                amountLabelEl.textContent = formatted.startsWith('Rp') ? formatted : formatCurrencyId(formatted);
            }
            if (originalPriceLabelEl) {
                const ob = data.originalBasePrice;
                const fb = data.finalBasePrice;
                if (typeof ob === "number" && typeof fb === "number" && fb < ob) {
                    originalPriceLabelEl.textContent = formatCurrencyId(ob);
                    originalPriceLabelEl.classList.remove('hidden');
                } else {
                    originalPriceLabelEl.classList.add('hidden');
                }
            }
            if (paymentTypeEl) {
                paymentTypeEl.textContent = data.paymentType === 'dp' ? 'DP (Down Payment)' : 'Lunas (Full Payment)';
            }
            if (methodEl) methodEl.textContent = data.paymentMethod || '-';
            if (bankEl) bankEl.textContent = data.bankName || '-';
            if (referralCodeEl) referralCodeEl.textContent = data.referralCode || '-';
            if (detailsWrapper) detailsWrapper.classList.remove('hidden');
            updateReceiptReferralDiscountDetail(data);

            if (dateLabelEl) {
                const d = data.createdAtMs ? new Date(data.createdAtMs) : new Date();
                dateLabelEl.textContent = d.toLocaleString('id-ID', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                });
            }

            const proofUrl = data.transferProofUrl || data.transferProofDataUrl || "";
            if (proofUrl) {
                if (proofImg) {
                    proofImg.src = proofUrl;
                }
                if (proofSection) proofSection.classList.remove('hidden');
                if (emptySection) emptySection.classList.add('hidden');
            } else {
                if (proofSection) proofSection.classList.add('hidden');
                if (emptySection) emptySection.classList.add('hidden');
            }
        }

        async function waitForReceiptFirestoreTools() {
            if (window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc) return true;
            let attempts = 0;
            while (!(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc) && attempts < 20) {
                await new Promise(function (resolve) { return setTimeout(resolve, 250); });
                attempts++;
            }
            return !!(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc);
        }

        function escapeHtml(value) {
            return String(value).replace(/[&<>"']/g, function (m) {
                return ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" })[m];
            });
        }

        function setupReceiptDetailsAccordion() {
            const toggle = document.getElementById('receiptDetailsToggle');
            const content = document.getElementById('receiptDetailsContent');
            const icon = document.getElementById('receiptDetailsIcon');
            if (!toggle || !content || !icon) return;
            toggle.addEventListener('click', function () {
                const isHidden = content.classList.contains('hidden');
                if (isHidden) {
                    content.classList.remove('hidden');
                    icon.textContent = "âˆ’";
                } else {
                    content.classList.add('hidden');
                    icon.textContent = "+";
                }
            });
        }

        function updateReceiptReferralDiscountDetail(data) {
            const block = document.getElementById('receiptReferralBlock');
            const valueEl = document.getElementById('receiptReferralValue');
            if (!block || !valueEl) return;
            const explicit = data && typeof data.discountAmount === "number" ? data.discountAmount : 0;
            const ob = data && typeof data.originalBasePrice === "number" ? data.originalBasePrice : 0;
            const fb = data && typeof data.finalBasePrice === "number" ? data.finalBasePrice : 0;
            let discount = explicit;
            if (!discount && ob && fb && fb < ob) {
                discount = ob - fb;
            }
            if (discount && discount > 0) {
                valueEl.textContent = formatCurrencyId(discount);
                block.classList.remove('hidden');
            } else {
                valueEl.textContent = "";
                block.classList.add('hidden');
            }
        }

        function renderReceiptProductDetails(product, productName) {
            const loadingEl = document.getElementById('receiptDetailsLoading');
            const curriculumBlock = document.getElementById('receiptCurriculumBlock');
            const curriculumList = document.getElementById('receiptCurriculumList');
            const featuresBlock = document.getElementById('receiptFeaturesBlock');
            const featuresList = document.getElementById('receiptFeaturesList');
            const specsBlock = document.getElementById('receiptSpecificationsBlock');
            const specsList = document.getElementById('receiptSpecificationsList');
            const subtitleEl = document.getElementById('receiptDetailsSubtitle');
            if (subtitleEl && productName) {
                subtitleEl.textContent = productName;
            }
            if (loadingEl) {
                loadingEl.classList.add('hidden');
            }
            if (!product) {
                if (loadingEl) {
                    loadingEl.textContent = "Detail program belum tersedia.";
                    loadingEl.classList.remove('hidden');
                }
                if (curriculumBlock) curriculumBlock.classList.add('hidden');
                if (featuresBlock) featuresBlock.classList.add('hidden');
                if (specsBlock) specsBlock.classList.add('hidden');
                return;
            }
            const materials = Array.isArray(product.materials) ? product.materials : [];
            const features = Array.isArray(product.features) ? product.features : [];
            const specifications = Array.isArray(product.specifications) ? product.specifications : [];
            if (curriculumBlock && curriculumList) {
                curriculumList.innerHTML = materials.map(function (item) {
                    const order = String(item.order || "").trim();
                    const title = String(item.title || "").trim();
                    const desc = String(item.description || "").trim();
                    const label = order ? order + ". " + title : title;
                    if (desc) {
                        return "<li><span class=\"font-semibold\">" + escapeHtml(label) + "</span><br><span class=\"text-[12px] text-slate-500\">" + escapeHtml(desc) + "</span></li>";
                    }
                    return "<li><span class=\"font-semibold\">" + escapeHtml(label) + "</span></li>";
                }).join("");
                if (materials.length) {
                    curriculumBlock.classList.remove('hidden');
                } else {
                    curriculumBlock.classList.add('hidden');
                }
            }
            if (featuresBlock && featuresList) {
                featuresList.innerHTML = features.map(function (feat) {
                    const label = String(feat && feat.label ? feat.label : "").trim() || "-";
                    const type = String(feat && feat.type ? feat.type : "").toLowerCase();
                    let valueLabel = "";
                    if (type === "boolean") {
                        valueLabel = feat && feat.value ? "Ya" : "Tidak";
                    } else {
                        valueLabel = String(feat && feat.value ? feat.value : "").trim();
                    }
                    if (!valueLabel) valueLabel = "-";
                    return "<li class=\"flex justify-between gap-4\"><span class=\"font-semibold\">" + escapeHtml(label) + "</span><span class=\"text-[12px] text-slate-600\">" + escapeHtml(valueLabel) + "</span></li>";
                }).join("");
                if (features.length) {
                    featuresBlock.classList.remove('hidden');
                } else {
                    featuresBlock.classList.add('hidden');
                }
            }
            if (specsBlock && specsList) {
                specsList.innerHTML = specifications.map(function (spec) {
                    const text = String(spec || "").trim();
                    return "<li>" + escapeHtml(text) + "</li>";
                }).join("");
                if (specifications.length) {
                    specsBlock.classList.remove('hidden');
                } else {
                    specsBlock.classList.add('hidden');
                }
            }
        }

        async function initProductDetailsForReceipt() {
            const data = lastReceiptData;
            const productId = data && data.productId ? String(data.productId).trim() : "";
            const productName = data && (data.productName || data.className) ? String(data.productName || data.className).trim() : "";
            if (!productId) {
                renderReceiptProductDetails(null, productName);
                return;
            }
            try {
                const ready = await waitForReceiptFirestoreTools();
                if (!ready || !(window.dlgInvoiceDb && window.dlgInvoiceDoc && window.dlgInvoiceGetDoc)) {
                    renderReceiptProductDetails(null, productName);
                    return;
                }
                const ref = window.dlgInvoiceDoc(window.dlgInvoiceDb, "products", productId);
                const snap = await window.dlgInvoiceGetDoc(ref);
                if (!snap.exists()) {
                    renderReceiptProductDetails(null, productName);
                    return;
                }
                const d = snap.data() || {};
                renderReceiptProductDetails(d, d.name || productName);
            } catch (e) {
                renderReceiptProductDetails(null, productName);
            }
        }

        function setupImageModal() {
            const proofImg = document.getElementById('receiptProofImage');
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('imageModalContent');
            if (!proofImg || !modal || !modalImg) return;
            proofImg.addEventListener('click', function () {
                if (!proofImg.src) return;
                modalImg.src = proofImg.src;
                modal.classList.remove('hidden');
            });
            modal.addEventListener('click', function () {
                modal.classList.add('hidden');
            });
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    modal.classList.add('hidden');
                }
            });
        }

        function openWhatsappConfirmation() {
            const url = window.location.href;
            let text = "Halo Admin Dialogika, saya sudah melakukan pembayaran.";
            const data = lastReceiptData;
            if (data) {
                const parts = [];
                if (data.leadName) parts.push("Nama: " + data.leadName);
                if (data.className) parts.push("Kelas: " + data.className);
                if (data.invoiceNumber) parts.push("Invoice: " + data.invoiceNumber);
                if (data.amountPaid) parts.push("Nominal: " + formatCurrencyId(data.amountPaid));
                text = "Halo Admin Dialogika, saya sudah melakukan pembayaran.\n" + parts.join("\n") + "\n\nBukti pembayaran: " + url;
            } else {
                text = "Halo Admin Dialogika, saya sudah melakukan pembayaran.\n\nBukti pembayaran: " + url;
            }
            const encoded = encodeURIComponent(text);
            const waNumber = "6285162992597";
            const waUrl = "https://wa.me/" + waNumber + "?text=" + encoded;
            window.open(waUrl, "_blank");
        }

        function printReceipt() {
            window.print();
        }

        function openInvoicePage() {
            let targetUrl = "invoice.html";
            if (invoiceIdFromUrl) {
                targetUrl += "?invoiceId=" + encodeURIComponent(invoiceIdFromUrl);
            }
            window.open(targetUrl, "_blank");
        }

        (async function () {
            await renderReceipt();
            setupReceiptDetailsAccordion();
            await initProductDetailsForReceipt();
            setupImageModal();
            const waBtn = document.getElementById('waConfirmBtn');
            if (waBtn) {
                waBtn.addEventListener('click', openWhatsappConfirmation);
            }
        })();
    </script>
</body>
</html>
